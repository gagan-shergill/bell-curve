<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Interactive Normal Distribution</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React + ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Font: Poppins (Geometric Humanist) -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
      body { font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }

      /* Landscape printing with default scaling */
      @page {
        size: landscape;
        margin: 0.5in;
      }

      @media print {
        body * { visibility: hidden; }
        .print-keep, .print-keep * { visibility: visible; }

        .print-keep {
          position: static;
          width: 100%;
          margin: 0;
          padding: 0;
        }

        /* Prevent curve from clipping */
        .print-keep .rounded-2xl {
          overflow: visible !important;
          box-shadow: none !important;
          border-color: #ccc !important;
        }

        svg {
          width: 100%;
          height: auto;
        }

        table {
          page-break-before: avoid;
          width: 100%;
          border-collapse: collapse;
          font-size: 10pt;
        }

        th, td {
          border: 1px solid #ccc;
          padding: 4px;
        }

        .no-print,
        .print-hide {
          display: none !important;
        }
      }
    </style>
  </head>

  <body class="bg-white">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useMemo } = React;

      /* ---------- math ---------- */
      function gaussian(x, mean, sd) {
        const coef = 1 / (sd * Math.sqrt(2 * Math.PI));
        const exp = Math.exp(-0.5 * Math.pow((x - mean) / sd, 2));
        return coef * exp;
      }

      function toStd100(value, type, axisSd) {
        if (type === "standard") return value;
        if (type === "z") return 100 + value * axisSd;
        if (type === "t") {
          const z = (value - 50) / 10;
          return 100 + z * axisSd;
        }
        if (type === "scaled") {
          const z = (value - 10) / 3;
          return 100 + z * axisSd;
        }
        return value;
      }

      /* ---------- qualitative ranges ---------- */
      const BASE_RANGES = [
        { min: -Infinity, max: 69,  tint: "#fecaca" }, // 0
        { min: 70,       max: 79,  tint: "#fed7aa" }, // 1
        { min: 80,       max: 89,  tint: "#fde68a" }, // 2
        { min: 90,       max: 109, tint: "#bbf7d0" }, // 3
        { min: 110,      max: 119, tint: "#bae6fd" }, // 4
        { min: 120,      max: 129, tint: "#c7d2fe" }, // 5
        { min: 130,      max: Infinity, tint: "#ddd6fe" }, // 6
      ];

      const BAND_LABELS = {
        en: [
          "Very Low",
          "Low",
          "Below Avg",
          "Average",
          "High Avg",
          "Very High",
          "Superior",
        ],
        es: [
          "Muy Bajo",
          "Bajo",
          "Low Average",
          "Promedio",
          "High Average",
          "Superior",
          "Muy Superior",
        ],
        yue: [
          "非常低",
          "低",
          "低平均水平",
          "平均",
          "高平均水平",
          "高",
          "非常高",
        ],
      };

      /* ---------- app ---------- */
      function BellCurveDashboard() {
        const [axisSd, setAxisSd] = useState(15);
        const [curveColor, setCurveColor] = useState("#bfe0ff99");
        const [markerDefault] = useState("#0ea5ff");
        const [name, setName] = useState("");
        const [type, setType] = useState("standard");
        const [value, setValue] = useState("");
        const [color, setColor] = useState("");
        const [items, setItems] = useState([]);
        const [showBands, setShowBands] = useState(false);
        const [showNumeric, setShowNumeric] = useState(true); // toggle numeric on markers
        const [lang, setLang] = useState("en"); // en, es, yue

        // Build language-specific range objects
        const RANGE_BANDS = useMemo(() => {
          const labels = BAND_LABELS[lang] || BAND_LABELS.en;
          return BASE_RANGES.map((r, i) => ({ ...r, label: labels[i] }));
        }, [lang]);

        const width = 1000, leftPad = 60, rightPad = 40;
        const innerWidth = width - leftPad - rightPad;
        const xMin = 40, xMax = 160, mean = 100;
        const rowGapY = 38, boxH = 36, boxGapX = 8;
        const topPad = 24, bottomPad = 70, baseHeight = 400, topRowGap = 16;
        const baseInnerHeight = baseHeight - topPad - bottomPad;

        const rowsNeeded = useMemo(() => {
          if (!items.length) return 1;
          const sorted = [...items].sort((a, b) => a.std100 - b.std100);
          const rowsRight = [];
          sorted.forEach((it) => {
            const label = `${it.name}`;
            const x = leftPad + ((it.std100 - xMin) / (xMax - xMin)) * innerWidth;
            const boxW = Math.max(84, label.length * 6 + 24);
            const proposedX = Math.max(leftPad + 4, Math.min(x - boxW / 2, leftPad + innerWidth - boxW - 4));
            let row = 0;
            while (true) {
              const rightEdge = rowsRight[row] ?? leftPad - boxGapX;
              if (proposedX >= rightEdge + boxGapX) { rowsRight[row] = proposedX + boxW; break; }
              row += 1;
            }
          });
          return Math.max(1, rowsRight.length);
        }, [items, innerWidth]);

        const baseRowsCapacity = Math.max(1, Math.floor((baseInnerHeight - topRowGap - boxH) / rowGapY) + 1);
        const extraRowsNeeded = Math.max(0, rowsNeeded - baseRowsCapacity);
        const height = baseHeight + extraRowsNeeded * rowGapY;
        const innerHeight = height - topPad - bottomPad;

        const xScale = (x) => leftPad + ((x - xMin) / (xMax - xMin)) * innerWidth;

        const curveGeom = useMemo(() => {
          const steps = 300;
          let maxY = 0;
          const xs = [], ys = [];
          for (let i = 0; i <= steps; i++) {
            const x = xMin + (i * (xMax - xMin)) / steps;
            const y = gaussian(x, mean, axisSd);
            xs.push(x); ys.push(y);
            if (y > maxY) maxY = y;
          }
          const scaleY = (y) => topPad + innerHeight - (y / maxY) * innerHeight;
          let d = "";
          for (let i = 0; i <= steps; i++) {
            const X = xScale(xs[i]);
            const Y = scaleY(ys[i]);
            d += i === 0 ? `M ${X} ${Y}` : ` L ${X} ${Y}`;
          }
          d += ` L ${xScale(xMax)} ${topPad + innerHeight} L ${xScale(xMin)} ${topPad + innerHeight} Z`;
          return { pathD: d };
        }, [axisSd, innerHeight, topPad]);

        const { pathD } = curveGeom;

        const addItem = (e) => {
          e.preventDefault();
          const num = Number(value);
          if (!isFinite(num)) return;
          const std100 = toStd100(num, type, axisSd);
          setItems(prev => [...prev, {
            id: Math.random().toString(36).slice(2),
            name: name.trim() || "(Unnamed)",
            inputType: type,
            inputValue: num,
            std100,
            color: color.trim() || undefined,
          }]);
          setName(""); setValue(""); setColor("");
        };

        const removeItem = (id) => setItems(prev => prev.filter(i => i.id !== id));
        const bandFor = (s) => (RANGE_BANDS.find(b => s >= b.min && s <= b.max) || {}).label || "";

        return (
          <div className="w-full min-h-screen bg-white text-slate-800 p-6">
            <div className="max-w-[1200px] mx-auto">
              <h1 className="text-2xl md:text-3xl font-semibold mb-2 print-hide">Interactive Normal Distribution</h1>

              {/* Controls */}
              <div className="grid lg:grid-cols-3 gap-4 mb-6 print-hide">
                <div className="p-4 rounded-2xl bg-white shadow-sm border">
                  <div className="flex items-center justify-between mb-3">
                    <span className="font-medium">Axis standard deviation</span>
                    <div className="flex items-center gap-2">
                      <button className={`px-3 py-1 rounded-full border ${axisSd===15?"bg-slate-900 text-white":"bg-white"}`} onClick={()=>setAxisSd(15)}>15</button>
                      <button className={`px-3 py-1 rounded-full border ${axisSd===10?"bg-slate-900 text-white":"bg-white"}`} onClick={()=>setAxisSd(10)}>10</button>
                    </div>
                  </div>

                  <div className="flex items-center justify-between mt-4">
                    <label className="text-sm">Curve Color</label>
                    <input type="color" value={curveColor} onChange={(e)=>setCurveColor(e.target.value)} className="w-10 h-8 rounded-md border cursor-pointer"/>
                  </div>

                  <label className="mt-3 flex items-center gap-2 text-sm">
                    <input type="checkbox" checked={showBands} onChange={(e)=>setShowBands(e.target.checked)} />
                    Show background bands
                  </label>

                  <label className="mt-2 flex items-center gap-2 text-sm">
                    <input type="checkbox" checked={showNumeric} onChange={(e)=>setShowNumeric(e.target.checked)} />
                    Show numeric scores on markers
                  </label>

                  <div className="mt-3">
                    <label className="text-sm block mb-1">Band language</label>
                    <select
                      className="w-full px-3 py-2 rounded-xl border"
                      value={lang}
                      onChange={(e)=>setLang(e.target.value)}
                    >
                      <option value="en">English</option>
                      <option value="es">Español</option>
                      <option value="yue">粵語 (Cantonese)</option>
                    </select>
                  </div>
                </div>

                {/* Input form */}
                <form onSubmit={addItem} className="p-4 rounded-2xl bg-white shadow-sm border lg:col-span-2">
                  <div className="grid md:grid-cols-4 gap-3 items-end">
                    <div>
                      <label className="text-sm">Subtest / Composite name</label>
                      <input className="mt-1 w-full px-3 py-2 rounded-xl border" value={name} onChange={(e)=>setName(e.target.value)} required/>
                    </div>
                    <div>
                      <label className="text-sm">Score type</label>
                      <select className="mt-1 w-full px-3 py-2 rounded-xl border" value={type} onChange={(e)=>setType(e.target.value)}>
                        <option value="standard">Standard (mean 100)</option>
                        <option value="t">T (mean 50, SD 10)</option>
                        <option value="scaled">Scaled (mean 10, SD 3)</option>
                        <option value="z">SD units (z)</option>
                      </select>
                    </div>
                    <div>
                      <label className="text-sm">Value</label>
                      <input type="number" step="any" className="mt-1 w-full px-3 py-2 rounded-xl border" value={value} onChange={(e)=>setValue(e.target.value)} required/>
                    </div>
                    <div className="flex items-end gap-2">
                      <div className="flex-1">
                        <label className="text-sm">(Optional) Marker color</label>
                        <input type="color" value={color || "#000000"} onChange={(e)=>setColor(e.target.value)} className="mt-1 w-full h-[42px] rounded-xl border cursor-pointer"/>
                      </div>
                      <button type="submit" className="h-[42px] px-4 rounded-xl bg-slate-900 text-white hover:bg-slate-800">Add</button>
                    </div>
                  </div>

                  {items.length > 0 && (
                    <div className="mt-3 flex flex-wrap gap-2">
                      {items.map(it => (
                        <span key={it.id} className="px-3 py-1 rounded-full bg-slate-100 border text-sm flex items-center gap-2">
                          <span className="inline-block w-3 h-3 rounded-full" style={{background: it.color || markerDefault}} />
                          {it.name} — {it.inputValue} {it.inputType}
                          <button onClick={() => removeItem(it.id)} className="ml-1 text-slate-500 hover:text-red-600" title="Remove">×</button>
                        </span>
                      ))}
                    </div>
                  )}
                </form>
              </div>

              {/* Printable area */}
              <div className="print-keep">
                <div className="rounded-2xl bg-white shadow-sm border overflow-hidden">
                  <svg width={1000} height={height} className="w-full">
                    {showBands && RANGE_BANDS.map((b, idx)=>{
                      const x1=Math.max(xMin,b.min===-Infinity?xMin:b.min);
                      const x2=Math.min(xMax,b.max===Infinity?xMax:b.max);
                      const X=xScale(x1); const W=xScale(x2)-xScale(x1);
                      return (
                        <g key={idx}>
                          <rect x={X} y={topPad} width={W} height={innerHeight} fill={b.tint} opacity={0.35}/>
                          <text x={X+W/2} y={topPad-6} textAnchor="middle" className="fill-slate-600 text-[12px]">{b.label}</text>
                        </g>
                      );
                    })}
                    <path d={pathD} fill={curveColor} stroke="#0f172a22" strokeWidth={1}/>
                    {(() => {
                      const sorted=[...items].sort((a,b)=>a.std100-b.std100);
                      const rowsRight=[],nodes=[];
                      sorted.forEach(it=>{
                        const label=it.name;
                        const val=Math.round(it.std100);
                        const cat=bandFor(it.std100);
                        const fill=it.color||markerDefault;
                        const x=xScale(it.std100);
                        const boxW=Math.max(84,label.length*6+24);
                        const proposedX=Math.max(leftPad+4,Math.min(x-boxW/2,leftPad+innerWidth-boxW-4));
                        let row=0; while(true){const rE=rowsRight[row]??leftPad-8;if(proposedX>=rE+8){rowsRight[row]=proposedX+boxW;break;}row++; }
                        const aX=proposedX,aY=topPad+16+38*row;
                        nodes.push(
                          <g key={it.id}>
                            <rect x={aX} y={aY} width={boxW} height={36} rx={10} ry={10} fill={fill}/>
                            <text x={aX+boxW/2} y={aY+15} textAnchor="middle" className="fill-white text-[12px] font-medium">{label}</text>
                            <text x={aX+boxW/2} y={aY+28} textAnchor="middle" className="fill-white text-[11px]">
                              {showNumeric ? `${val} • ${cat}` : `${cat}`}
                            </text>
                          </g>
                        );
                      }); 
                      return nodes;
                    })()}
                  </svg>
                </div>

                {items.length>0 && (
                  <div className="mt-8 bg-white rounded-2xl shadow-sm border p-4" id="scoreTable">
                    <div className="flex justify-between items-center mb-3">
                      <h2 className="text-lg font-semibold">Entered Scores</h2>
                      <button onClick={()=>window.print()} className="px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 no-print">Print / Save as PDF</button>
                    </div>
                    <table className="min-w-full border border-slate-200 text-sm">
                      <thead className="bg-slate-100">
                        <tr>
                          <th className="border p-2 text-left">Subtest / Composite</th>
                          <th className="border p-2 text-left">Score Type</th>
                          <th className="border p-2 text-left">Input Value</th>
                          <th className="border p-2 text-left">Converted (Std-100)</th>
                          <th className="border p-2 text-left">Category</th>
                          <th className="border p-2 text-left">Color</th>
                          <th className="border p-2 text-left">Remove</th>
                        </tr>
                      </thead>
                      <tbody>
                        {items.map(it=>(
                          <tr key={it.id}>
                            <td className="border p-2">{it.name}</td>
                            <td className="border p-2">{it.inputType}</td>
                            <td className="border p-2">{it.inputValue}</td>
                            <td className="border p-2">{Math.round(it.std100)}</td>
                            <td className="border p-2">{bandFor(it.std100)}</td>
                            <td className="border p-2"><span className="inline-block w-5 h-5 rounded-md border" style={{background:it.color||markerDefault}}></span></td>
                            <td className="border p-2"><button onClick={()=>removeItem(it.id)} className="px-2 py-1 rounded-md border hover:bg-red-50 hover:text-red-700">Remove</button></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<BellCurveDashboard />);
    </script>
  </body>
</html>
